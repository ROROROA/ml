# prefect.yaml (远程拉取代码模式)
#
# 这个文件是你的所有工作流部署的“单一事实来源”。
# 当你运行 `prefect deploy` 时，它会读取此文件，并
# 在 Prefect Server 上创建或更新下面定义的所有部署。

# ----------------------------------------------------
# 拉取 (Pull) 配置
# ----------------------------------------------------
# 这里定义了 Worker 在运行 Flow 之前如何获取最新的代码。
# 这个步骤会在 K8s Job 启动时被执行。
pull: # <--- 变化点：从 build: 变成了 pull:
  # 使用 prefect-git 从 Git 仓库克隆代码。
  # 你需要先运行 `pip install prefect-git` (并把它加到你的基础镜像里)
  - prefect.deployments.steps.git_clone:

      repository: https://github.com/ROROROA/ml.git # <--- 变化点：填写你的仓库URL
      # --- （可选）指定分支，默认为 master/main ---
      branch: main # <--- 变化点：填写你的代码分支

      # --- （可选）如果你的仓库是私有的，取消下面一行的注释 ---
      # access_token: "{{ prefect.blocks.secret.github-access-token }}"
      # credentials: "{{ prefect.blocks.github-credentials.my-github-credentials }}"


# ----------------------------------------------------
# 部署 (Deployments) 配置
# ----------------------------------------------------
# 在这里列出你希望部署到 Prefect Server 的每一个 flow。
deployments:
  - name: "daily-data-pipeline"
    description: "每日运行的特征工程与物化管道。"
    entrypoint: src/pipelines/data_pipeline.py:data_pipeline_flow
    work_pool:
      name: "kubernetes-pool"
      job_variables:
        # --- 请将这里替换成你构建的基础镜像名称 ---
        image: "my-ml-base-image:latest" # <--- 变化点：使用固定的基础镜像
        # 对于本地开发，pull策略保持'Never'是OK的，
        # 如果你的基础镜像推到了远程仓库，可以改为 'IfNotPresent'
        image_pull_policy: "Never"

  - name: "model-training-pipeline"
    description: "用于模型训练、评估和注册的管道。通常手动触发或由性能监控触发。"
    entrypoint: src/pipelines/training_pipeline.py:training_pipeline_flow
    work_pool:
      name: "kubernetes-pool"
      job_variables:
        image: "my-ml-base-image:latest" # <--- 变化点
    task_runner:
      type: RayTaskRunner
      config:
        address: "ray://ray-kuberay-cluster-head-svc.default.svc.cluster.local:10001"
        init_kwargs:
          runtime_env:
            pip:
              - "pandas==2.3.2"
              - "feast==0.53.0"
              - "prefect==3.4.18" 
              - "mlflow==3.3.2"
              - "prefect-ray==0.4.5"

  - name: "apply-feast-definitions"
    description: "将 feature_repo/ 中的特征定义应用到 Feast 注册表。"
    entrypoint: src/pipelines/apply_pipeline.py:apply_pipeline_flow
    work_pool:
      name: "kubernetes-pool"
      job_variables:
        image: "my-ml-base-image:latest" # <--- 变化点

  - name: "promote-pipeline"
    description: "用于将一个已验证的模型版本提升到'生产'或'Staging'阶段的流程。"
    entrypoint: src/pipelines/promote_pipeline.py:promote_pipeline_flow
    work_pool:
      name: "kubernetes-pool"
      job_variables:
        image: "my-ml-base-image:latest" # <--- 变化点